<template component="uifactory-preview" code="Type code here">
  <style>
    uifactory-preview {
      display: flex;
      height: 300px;
    }
    uifactory-preview uifactory-vscode {
      width: 50%;
    }
    uifactory-preview > section {
      display: flex;
      width: 50%;
    }
    uifactory-preview > section > iframe {
      flex: 1;
      border: none;
    }
  </style>

  <uifactory-vscode
    onkeyup="updatePreview(event)"
    language="html"
    theme="vs-dark">
    <code>
      <%= _.escape(code) %>
    </code>
  </uifactory-vscode>
  <section></section>

  <script>
    function updatePreview(e) {
      const target = e.target.closest('uifactory-preview')
      const container = target.querySelector('section')
      container.innerHTML = ''
      const iframe = document.createElement('iframe')
      container.appendChild(iframe)
      const html = target.querySelector('uifactory-vscode').editor.getValue()
      iframe.contentDocument.body.innerHTML = html
      target.__set('code', html)
      uifactory.register(iframe.contentDocument, { window: iframe.contentWindow })
    }
    document.body.addEventListener('render', function(e) {
      if (!e.target.matches('uifactory-preview')) return
      new Promise(res => {
        // Check if Monaco is initialized
        const interval = setInterval(()  => {
          if ('editor' in e.target.querySelector('uifactory-vscode')) {
            clearInterval(interval)
            res()
          }
        }, 100)
      }).then(() => {
        updatePreview(e)
      })
    }, { once: true })
  </script>
</template>


<template component="uifactory-vscode">
  <script type="application/json">
    {
      "properties": [
        {
          "name": "value",
          "value": "alert('Hello')"
        },
        {
          "name": "language",
          "value": "javascript"
        },
        {
          "name": "theme",
          "value": "vs-dark"
        }
      ]
    }
  </script>
  <% var code = this.querySelector('code').innerHTML || '' %>
  <code>
    <%= code %>
  </code>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.23.0/min/vs/loader.js"></script>
  <script>
    document.body.addEventListener('render', function(e) {
      if(!e.target.matches('uifactory-vscode')) return
      require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs' }});
      require(
        ["vs/editor/editor.main"],
        function () {
          if ('editor' in e.target) return
          var code = e.target.querySelector('code').textContent.trim()
          e.target.innerHTML = ''
          e.target.editor =
          monaco.editor.create(
            e.target, {
              value: code,
              language: e.target.language || 'html',
              theme: e.target.theme || 'vs-dark',
              automaticLayout: true,
              minimap: {
                enabled: false
              }
            }
          );
      });
      if(!window.MonacoEnvironment) {
        window.MonacoEnvironment = { getWorkerUrl: () => proxy };
        let proxy = URL.createObjectURL(
          new Blob(
            [
              "self.MonacoEnvironment = { " +
                  "baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min'" +
              "};" +
              "importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/base/worker/workerMain.min.js');"
            ],
            {
              type: 'text/javascript'
            }
          )
        );
      }
    }, { matchTarget: true })
  </script>
</template>
